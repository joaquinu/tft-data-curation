name: Weekly TFT Data Collection

on:
  schedule:
    # Run every Sunday at midnight UTC (0 0 * * 0)
    - cron: '0 0 * * 0'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      collection_mode:
        description: 'Collection mode'
        required: true
        default: 'weekly'
        type: choice
        options:
        - weekly
        - incremental
        - test
      
      dry_run:
        description: 'Dry run (test mode without actual collection)'
        required: false
        default: false
        type: boolean

jobs:
  collect-tft-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests python-dotenv rdflib networkx
        # Add any other dependencies your project needs
    
    - name: Verify environment setup
      env:
        RIOT_API_KEY: ${{ secrets.RIOT_API_KEY }}
      run: |
        echo "[INFO] Verifying environment setup..."
        if [ -z "$RIOT_API_KEY" ]; then
          echo "[ERROR] RIOT_API_KEY secret not set!"
          exit 1
        fi
        echo "[SUCCESS] RIOT_API_KEY configured"
        
    - name: Create logs directory
      run: mkdir -p logs
    
    - name: Run TFT data collection
      env:
        RIOT_API_KEY: ${{ secrets.RIOT_API_KEY }}
        COLLECTION_MODE: ${{ github.event.inputs.collection_mode || 'weekly' }}
        DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
      run: |
        echo "[INFO] Starting TFT data collection..."
        echo "Mode: $COLLECTION_MODE"
        echo "Dry run: $DRY_RUN"
        
        # Prepare arguments
        DRY_RUN_FLAG=""
        if [ "$DRY_RUN" = "true" ]; then
          DRY_RUN_FLAG="--dry-run"
        fi
        
        # Run the collection
        python3 scripts/automated_collection.py \
          --mode "$COLLECTION_MODE" \
          --config scripts/automated_collection_config.example.json \
          $DRY_RUN_FLAG \
          --log-level INFO
    
    - name: Upload collection logs
      uses: actions/upload-artifact@v3
      if: always()  # Always upload logs, even if the job fails
      with:
        name: tft-collection-logs-${{ github.run_number }}
        path: |
          logs/
          *.log
        retention-days: 30
    
    - name: Upload collected data
      uses: actions/upload-artifact@v3
      if: success()  # Only upload data if collection succeeded
      with:
        name: tft-data-${{ github.run_number }}
        path: |
          *.json
          data/
        retention-days: 90
    
    - name: Notify on failure
      if: failure()
      env:
        WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}  # Optional Discord webhook
      run: |
        echo "[ERROR] TFT Data Collection failed!"
        echo "Check the logs in the GitHub Actions tab."
        
        # Optional: Send Discord notification
        if [ ! -z "$WEBHOOK_URL" ]; then
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\":\"[ERROR] TFT Data Collection failed! Check GitHub Actions for details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
               "$WEBHOOK_URL"
        fi

    - name: Summary
      if: always()
      run: |
        echo "[INFO] TFT Data Collection Summary"
        echo "=============================="
        echo "Job status: ${{ job.status }}"
        echo "Run ID: ${{ github.run_id }}"
        echo "Timestamp: $(date -u)"
        echo ""
        
        if [ -f "logs/automated_collection.log" ]; then
          echo "[INFO] Recent log entries:"
          tail -10 logs/automated_collection.log
        fi
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "[SUCCESS] Collection completed successfully!"
          
          # Show file sizes of collected data
          echo ""
          echo "[INFO] Collected data files:"
          ls -lh *.json 2>/dev/null || echo "No JSON files found"
        else
          echo "[ERROR] Collection failed - check logs for details"
        fi
